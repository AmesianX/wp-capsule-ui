(function(e){window.editors={},window.Capsule={},Capsule.delaySave={};Capsule.spinner=function(e){typeof e=="undefined"&&(e=capsuleL10n.loading);return'<div class="spinner"><span>'+e+"</span></div>"};Capsule.authCheck=function(e){if(typeof e.result!="undefined"&&e.result=="unauthorized"){alert(e.msg);location.href=e.login_url+"?redirect_to="+encodeURIComponent(location.href);return!1}return!0};Capsule.get=function(t,n,r,i){e.get(t,n,function(e){Capsule.authCheck(e)&&r.call(this,e)},i)};Capsule.post=function(t,n,r,i){e.post(t,n,function(e){Capsule.authCheck(e)&&r.call(this,e)},i)};Capsule.loadExcerpt=function(t,n){t.addClass("unstyled").children().addClass("transparent").end().append(Capsule.spinner());Capsule.get(capsuleL10n.endpointAjax,{capsule_action:"post_excerpt",post_id:n},function(r){if(r.html){t.replaceWith(r.html);t=e("#post-content-"+n);Capsule.postExpandable(t);e("#post-content-"+n).scrollintoview({offset:10})}},"json")};Capsule.centerEditor=function(t){e.scrollTo("#post-edit-"+t,{offset:-10})};Capsule.loadEditor=function(e,t){e.addClass("unstyled").children().addClass("transparent").end().append(Capsule.spinner());Capsule.get(capsuleL10n.endpointAjax,{capsule_action:"post_editor",post_id:t},function(n){if(n.html){e.replaceWith(n.html);Capsule.centerEditor(t);Capsule.sizeEditor();Capsule.initEditor(t,n.content)}},"json")};Capsule.createPost=function(e){e.addClass("unstyled").children().addClass("transparent").end().append(Capsule.spinner());Capsule.post(capsuleL10n.endpointAjax,{capsule_action:"create_post"},function(t){if(t.html){e.replaceWith(t.html);Capsule.centerEditor(t.post_id);Capsule.sizeEditor();Capsule.initEditor(t.post_id,"")}},"json")};Capsule.watchForEditorChanges=function(t,n,r){typeof n=="undefined"&&(n=e("#post-edit-"+t));typeof r=="undefined"&&(r=!1);var i=(new Date).getTime()/1e3,s=date("g:i a",i),o=function(){Capsule.delaySave[t]=null;Capsule.updatePost(t,window.editors[t].getSession().getValue())},u=function(){n.clearQueue().addClass("dirty");Capsule.delaySave[t]&&clearTimeout(Capsule.delaySave[t]);Capsule.delaySave[t]=setTimeout(o,1e4);window.editors[t].getSession().removeEventListener("change",u);return!0};r||n.find("span.post-last-saved").html(s);window.editors[t].getSession().on("change",u);n.delay(50).queue(function(){e(this).removeClass("dirty").dequeue()})};Capsule.updatePost=function(t,n,r,i){typeof i=="undefined"&&(i=!1);typeof r=="undefined"&&(r=e("#post-edit-"+t));i?r.addClass("unstyled").children().addClass("transparent").end().append(Capsule.spinner()):r.addClass("saving");var s=n.replace(/^```([^]+?)^```/mg,"").replace(/<pre>([^]+?)<\/pre>/mg,"").replace(/<code>([^]+?)<\/code>/mg,""),o=twttr.txt.extractMentions(s),u=twttr.txt.extractHashtags(s),a=Capsule.extractCodeLanguages(n);Capsule.post(capsuleL10n.endpointAjax,{capsule_action:"update_post",post_id:t,content:n,projects:JSON.stringify(o),post_tag:JSON.stringify(u),code:JSON.stringify(a)},function(e){if(e.result=="success")if(i)Capsule.loadExcerpt(r,t);else{r.removeClass("saving");Capsule.watchForEditorChanges(t,r)}},"json")};Capsule.deletePost=function(e,t){t.addClass("unstyled").children().addClass("transparent").end().append(Capsule.spinner());Capsule.post(capsuleL10n.endpointAjax,{capsule_action:"delete_post",post_id:e},function(e){if(e.result=="success")t.replaceWith(e.html);else{alert(e.msg);t.removeClass("unstyled").children().removeClass("transparent").end().find(".spinner").remove()}},"json")};Capsule.undeletePost=function(t,n){n.addClass("unstyled").children().addClass("transparent").end().append(Capsule.spinner());Capsule.post(capsuleL10n.endpointAjax,{capsule_action:"undelete_post",post_id:t},function(r){if(r.result=="success"){n.replaceWith(r.html);n=e("#post-content-"+t);Capsule.postExpandable(n)}else{alert(r.msg);n.removeClass("unstyled").children().removeClass("transparent").end().find(".spinner").remove()}},"json")};Capsule.stickPost=function(e,t){t.addClass("sticky-loading");Capsule.post(capsuleL10n.endpointAjax,{capsule_action:"stick_post",post_id:e},function(e){e.result=="success"?t.addClass("sticky").removeClass("sticky-loading"):alert(e.msg)},"json")};Capsule.unstickPost=function(e,t){t.addClass("sticky-loading");Capsule.post(capsuleL10n.endpointAjax,{capsule_action:"unstick_post",post_id:e},function(e){e.result=="success"?t.removeClass("sticky sticky-loading"):alert(e.msg)},"json")};Capsule.initEditor=function(e,t){window.Capsule.CFMarkdownMode=require("cf/js/syntax/cfmarkdown").Mode;window.editors[e]=ace.edit("ace-editor-"+e);window.editors[e].getSession().setUseWrapMode(!0);window.editors[e].getSession().setMode("cf/js/syntax/cfmarkdown");window.editors[e].setShowPrintMargin(!1);window.editors[e].setTheme("ace/theme/twilight");window.editors[e].getSession().setValue(t);window.editors[e].container.style.lineHeight="20px";window.editors[e].renderer.setPadding(12);window.editors[e].commands.addCommand({name:"save",bindKey:{win:"Ctrl-S",mac:"Command-S"},exec:function(t){Capsule.updatePost(e,t.getSession().getValue())}});window.editors[e].commands.addCommand({name:"recenter",bindKey:{mac:"Command-Shift-0",win:"Ctrl-Shift-0"},exec:function(t){Capsule.centerEditor(e)}});Capsule.watchForEditorChanges(e,undefined,!0);window.editors[e].focus()};Capsule.sizeEditor=function(){e(".ace-editor:not(.resized)").each(function(){e(this).height(e(window).height()-e(this).closest("article").find("header").height()-70+"px")})};Capsule.saveAllEditors=function(){e(".ace-editor").each(function(){var t=e(this).closest("article"),n=t.data("post-id");t.hasClass("dirty")&&Capsule.updatePost(n,window.editors[n].getSession().getValue())})};Capsule.extractCodeLanguages=function(t){var n=new RegExp("^```[a-zA-Z]+\\s*$","gm"),r=new RegExp("[a-zA-Z]+",""),i=[],s=t.match(n);s!=null&&s.length&&e.each(s,function(e,t){i.push(t.match(r)[0].replace(/^js$/i,"javascript"))});return i};Capsule.postExpandable=function(e){e.find(".post-content:first")[0].scrollHeight>e[0].scrollHeight&&e.addClass("toggleable")};e(function(){e(".js-search").suggest(capsuleSearchURL+"?capsule_action=search",{delay:500,minchars:2,multiple:!0,multipleSep:" ",resultsClass:"search_results",selectClass:"search_selected",matchClass:"search_match"});e(document).on("click","article.excerpt.toggleable .post-content",function(t){e(this).closest("article.excerpt.toggleable").removeClass("excerpt").addClass("open")}).on("click","article:not(.excerpt, a.post-edit-link) .post-toggle",function(t){e(this).closest("article").removeClass("open").addClass("excerpt")}).on("click","article .post-edit-link",function(t){var n=e(this).closest("article"),r=n.data("post-id");Capsule.loadEditor(n,r);t.preventDefault();n.hasClass("excerpt")&&t.stopPropagation()}).on("click","article .post-close-link",function(t){t.preventDefault();var n=e(this).closest("article"),r=n.data("post-id");Capsule.updatePost(r,window.editors[r].getSession().getValue(),n,!0)}).on("click","article .post-save-link",function(t){t.preventDefault();var n=e(this).closest("article"),r=n.data("post-id");Capsule.updatePost(r,window.editors[r].getSession().getValue());window.editors[r].focus()}).on("click","article .post-delete-link",function(t){t.stopPropagation();t.preventDefault();var n=e(this).closest("article"),r=n.data("post-id");Capsule.deletePost(r,n)}).on("click","article .post-undelete-link",function(t){t.stopPropagation();t.preventDefault();var n=e(this).closest("article"),r=n.data("post-id");Capsule.undeletePost(r,n)}).on("click","article:not(.sticky) .post-stick-link",function(t){t.stopPropagation();t.preventDefault();var n=e(this).closest("article"),r=n.data("post-id");Capsule.stickPost(r,n)}).on("click","article.sticky .post-stick-link",function(t){t.stopPropagation();t.preventDefault();var n=e(this).closest("article"),r=n.data("post-id");Capsule.unstickPost(r,n)}).on("mousewheel","article.edit",function(e){e.preventDefault()}).on("click",".post-new-link",function(t){t.preventDefault();var n=e("<article></article>").height("400px");e(".body").prepend(n);Capsule.createPost(n)});e(window).on("resize",function(){Capsule.sizeEditor()}).on("blur",function(){Capsule.saveAllEditors()});e("article").each(function(){Capsule.postExpandable(e(this))})})})(jQuery);